#!/usr/bin/env bash

# compiles benchmark and run switch converter and instruction namer on it

file="$1"
ext="${file##*\.}"

clang_out=${file/.$ext/.ll}

echo "output to:" $clang_out

include_path="/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX.sdk/usr/include"
include_path_two="${PWD}/tests"

if [[ $file == *.c ]]
then
  clang -O0 -I $include_path -I $include_path_two -c -emit-llvm -S $file -o $clang_out
else
  clang++ -O0 -I $include_path -I $include_path_two -c -emit-llvm -S $file -o $clang_out
fi

#opt -lowerswitch -instnamer -S $clang_out > tmp.ll
opt -lowerinvoke --unreachableblockelim -instnamer -S $clang_out > tmp.ll

mv tmp.ll $clang_out

loops_out=${file/.$ext/.loops}
echo "output loops info to:" $loops_out
opt -enable-new-pm=0 -analyze -loops $clang_out > $loops_out
